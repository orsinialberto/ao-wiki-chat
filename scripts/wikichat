#!/bin/bash
#
# WikiChat CLI Wrapper Script for Unix/macOS
# This script provides a convenient way to run the WikiChat CLI without
# explicitly calling java -jar.
#

set -e

# Script directory (where this script is located)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
CLI_DIR="$PROJECT_ROOT/ao-wiki-chat-cli"
JAR_NAME="ao-wiki-chat-cli-0.0.1-SNAPSHOT.jar"
JAR_PATH="$CLI_DIR/target/$JAR_NAME"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print error messages
error() {
    echo -e "${RED}Error:${NC} $1" >&2
}

# Function to print warning messages
warning() {
    echo -e "${YELLOW}Warning:${NC} $1" >&2
}

# Function to print info messages
info() {
    echo -e "${GREEN}Info:${NC} $1"
}

# Function to check if Java is installed and get version
check_java() {
    if ! command -v java &> /dev/null; then
        error "Java is not installed or not in PATH"
        echo "Please install Java 25 or later and ensure it's in your PATH"
        exit 1
    fi

    # Get Java version
    JAVA_VERSION=$(java -version 2>&1 | head -n 1 | cut -d'"' -f2 | sed '/^1\./s///' | cut -d'.' -f1)
    
    # Check if version is 25 or higher
    if [ -z "$JAVA_VERSION" ] || [ "$JAVA_VERSION" -lt 25 ]; then
        error "Java 25 or later is required. Found Java version: $JAVA_VERSION"
        echo "Please install Java 25 or later"
        exit 1
    fi

    info "Java version check passed: Java $JAVA_VERSION"
}

# Function to check if JAR exists
check_jar() {
    if [ ! -f "$JAR_PATH" ]; then
        error "JAR file not found: $JAR_PATH"
        echo ""
        echo "Please build the CLI first:"
        echo "  cd $PROJECT_ROOT"
        echo "  ./mvnw clean package -pl ao-wiki-chat-cli -am"
        exit 1
    fi
}

# Function to find Java executable
find_java() {
    if command -v java &> /dev/null; then
        JAVA_CMD="java"
    else
        error "Java executable not found in PATH"
        exit 1
    fi
}

# Main execution
main() {
    # Check Java installation and version
    check_java
    
    # Find Java executable
    find_java
    
    # Check if JAR exists
    check_jar
    
    # Execute the CLI with all arguments passed to this script
    exec "$JAVA_CMD" -jar "$JAR_PATH" "$@"
}

# Run main function with all arguments
main "$@"
